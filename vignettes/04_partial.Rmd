---
title: "Practice: Example of Partial Analysis"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
header-includes:
  - \usepackage[utf8]{inputenc}
vignette: >
  %\VignetteIndexEntry{Practice: Example of Partial Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  tidy = "styler",
  collapse = TRUE,
  comment = "#>"
)
stopifnot(
  require(tidyverse),
  require(rjavacmecab)
)
```

## MeCabにコマンドラインオプションを渡す

`rjavacmecab::fastestword`は`base::system`関数からMeCabを外部コマンドとして直接実行することができるものです。このとき、MeCabのコマンドラインオプションをoptに引数として渡すことで、オプション付きでMeCabを実行することができます。

### -Owakati

```{r wakati}
output_path <- rjavacmecab::fastestword(
  "みなさまが、焼き餃子だと居間で噂するクラッチを持たせていただきました",
  opt = "-Owakati", ## equal to default.
  encoding = "CP932"
)
readLines(output_path)
```

### -Oyomi

```{r yomi}
output_path <- rjavacmecab::fastestword(
  "みなさまが、焼き餃子だと居間で噂するクラッチを持たせていただきました",
  opt = "-Oyomi",
  encoding = "CP932"
)
readLines(output_path)
```

### -Ochasen

```{r chasen}
output_path <- rjavacmecab::fastestword(
  "みなさまが、焼き餃子だと居間で噂するクラッチを持たせていただきました",
  opt = "-Ochasen",
  encoding = "CP932"
)
file <- readLines(output_path)
readr::read_tsv(
  file,
  col_names = FALSE,
  quote = "",
  n_max = length(file) - 1L ## Suppress warning message that EOS line can't be parsed.
)
```

## 制約付き解析（部分解析）の一例

MeCabのやや発展的な使い方のひとつとして、[制約付き解析](https://taku910.github.io/mecab/partial.html)があります。

> 入力文の一部の形態素情報が既知である、あるいは境界がわかっているときに、 それを満たすように解析する機能です。
>
> たとえば、「にわにはにわにわとりがいる。」という文に対して、 「はにわ」の部分が名詞であるとか、「にわとり」の部分が一つの形態素 であるというように指定した上で解析することができます。このとき、 制約に反する4文字目の「は」が単独で形態素となったり、「にわとり」が「にわ」と「とり」 に分割されるような解析候補は排除されます。

ここでは「くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～」（意訳：うわー、きゃりーぱみゅぱみゅちゃんのPVはすごくかわいいなぁ）という文を意図どおりに解析させることを試みます。

### IPA辞書による素の解析の場合

標準のIPA辞書で解析するとうまく解析されていません。

```{r}
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～")
output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "", ## MeCab標準の形式で出力させるために空文字をオプションとして渡す
  encoding = "CP932"
)
file <- readLines(output_path)
readr::read_tsv(
  file,
  col_names = FALSE,
  quote = "",
  n_max = length(file) - 1L
)
```

MeCabはデフォルトだと未知語についても品詞推定をおこないますが、推定された未知語の多くは名詞一般になります。未知語と判定された形態素について品詞推定をせず、特定の素性パターンを表示させるには次のようにします。

```{r}
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～")
output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--unk-feature Unknown",
  encoding = "CP932"
)
file <- readLines(output_path)
readr::read_tsv(
  file,
  col_names = FALSE,
  quote = "",
  n_max = length(file) - 1L
)
```

### 制約付き解析の場合

`rjavacmecab::fastestword`は与えられた文字列ベクトルをそのまま`base::writeLines`に渡し、書き出したファイルをMeCabに解析させます。`base::writeLines`に渡された文字列ベクトルは要素ごとにsepで指定した文字で区切られて書き出される（デフォルトでは改行で区切られる）ため、制約付き解析をする場合は以下のような形式の文字列を用意します。

```{r}
input_text <- c(
  "くぅ～\t感動詞", ## 形態素断片とその素性パターンは"\t"で区切る
  "きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～", ## 通常の文字列は文断片として処理される
  "EOS" ## 改行を含む文を部分解析モードで解析する場合、文末記号として"EOS"を与える
)

output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--partial --unk-feature Unknown",
  encoding = "CP932"
)
file <- readLines(output_path)
readr::read_tsv(
  file,
  col_names = FALSE,
  quote = "",
  n_max = length(file) - 1L
)
```

実用的には、たとえば次のように使うことができます。

```{r}
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～") %>%
  purrr::map_chr(function(str) {
    str %>%
      stringr::str_replace_all("くぅ～", "くぅ～\t感動詞\n") %>%
      stringr::str_replace_all("きゃりーぱみゅぱみゅ", "きゃりーぱみゅぱみゅ\t名詞,固有名詞,人名,一般\n") %>%
      stringr::str_replace_all("たそ", "たそ\t名詞,接尾,人名\n") %>%
      stringr::str_replace_all("ぴーぶい", "ぴーぶい\t名詞,一般\n") %>%
      stringr::str_replace_all("ぐうかわ", "ぐうかわ\t名詞,形容動詞語幹\n")
  }) %>%
  c("EOS")

output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--partial",
  encoding = "CP932"
)
file <- readLines(output_path)
out <- file %>%
  readr::read_tsv(
    col_names = FALSE,
    quote = "",
    n_max = length(file) - 1L
  ) %>%
  tidyr::separate(
    col = X2,
    into = c(
      "品詞",
      "品詞細分類1",
      "品詞細分類2",
      "品詞細分類3",
      "活用型",
      "活用形",
      "原形",
      "読み",
      "発音"
    ),
    sep = ",",
    fill = "right"
  )
out
```

また、形態素断片の素性パターンにワイルドカードを使うとその単語を切り出しながら品詞については適当なものを付与させることができます。以下では「の」と「ぴーぶい」については常に単語として切り出しながら、品詞は適当なものを付与させています。ユーザー辞書で未知語を定義する場合と比べて、形態素としての区切りは与えながらも品詞の推定はMeCabにやらせたいという場合に使うことができます。

```{r}
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～") %>%
  purrr::map_chr(function(str) {
    str %>%
      stringr::str_replace_all("くぅ～", "くぅ～\t感動詞\n") %>%
      stringr::str_replace_all("きゃりーぱみゅぱみゅ", "きゃりーぱみゅぱみゅ\t名詞,固有名詞,人名,一般\n") %>%
      stringr::str_replace_all("たそ", "たそ\t名詞,接尾,人名\n") %>%
      stringr::str_replace_all("の", "の\t*\n") %>%
      stringr::str_replace_all("ぴーぶい", "ぴーぶい\t*\n") %>%
      stringr::str_replace_all("ぐうかわ", "ぐうかわ\t名詞,形容動詞語幹\n")
  }) %>%
  c("EOS")

output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--partial",
  encoding = "CP932"
)
file <- readLines(output_path)
out <- file %>%
  readr::read_tsv(
    col_names = FALSE,
    quote = "",
    n_max = length(file) - 1L
  ) %>%
  tidyr::separate(
    col = X2,
    into = c(
      "品詞",
      "品詞細分類1",
      "品詞細分類2",
      "品詞細分類3",
      "活用型",
      "活用形",
      "原形",
      "読み",
      "発音"
    ),
    sep = ",",
    fill = "right"
  )
out
```

## 参考

- [Mecabなど形態素解析で使うIPA品詞体系（品詞ID｜pos-id） - MS Tech](http://miner.hatenablog.com/entry/323)
- [MeCabの制約付き解析モードを利用する - kensuke-miの日記](http://kensuke-mi.hatenablog.com/entry/2015/03/09/213528)

